<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Test</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body>
    <div>
        <h2>WebSocket Test Client</h2>
        <div>
            <label for="email">Your Email:</label>
            <input type="text" id="email" placeholder="your@email.com"/>
            <button onclick="connect()">Connect</button>
        </div>
        <hr/>
        <div>
            <label for="conversationId">Conversation ID:</label>
            <input type="text" id="conversationId" />
            <label for="content">Message:</label>
            <input type="text" id="content" />
            <button onclick="sendMessage()">Send</button>
        </div>
        <hr/>
        <h3>Messages:</h3>
        <ul id="messages"></ul>
    </div>

    <script>
        let stompClient = null;

        function connect() {
            const email = document.getElementById('email').value;
            // include email on the handshake URL so UserHandshakeHandler picks it up
            const socket = new SockJS(
                `http://localhost:8080/ws?email=${encodeURIComponent(email)}`
            );
            stompClient = Stomp.over(socket);

            stompClient.connect(
                {},                     // no need to pass STOMP headers now
                frame => {
                    addMessage(`Connected as ${frame.headers['user-name']}`);
                    // -------------------------------------------------------
                    // 2) subscribe to your personal queue so you actually see messages
                    stompClient.subscribe(
                        '/user/queue/messages',
                        msg => {
                            const m = JSON.parse(msg.body);
                            addMessage(`Received: ${m.content} (from ${m.senderEmail})`);
                        }
                    );
                    // optional: subscribe to your connect‐confirmation queue
                    stompClient.subscribe(
                        '/user/queue/connect',
                        msg => {
                            const data = JSON.parse(msg.body);
                            addMessage(`Connect status: ${data.status}`);
                        }
                    );
                    // tell the server “I’m here”
                    stompClient.send('/app/chat.addUser', {}, '{}');
                    // -------------------------------------------------------
                },
                err => addMessage('Error: ' + err)
            );
        }

        function sendMessage() {
            const conversationId = document.getElementById('conversationId').value;
            const content = document.getElementById('content').value;

            if (stompClient && conversationId && content) {
                stompClient.send(
                    '/app/chat.sendMessage',
                    {},
                    JSON.stringify({ conversationId, content })
                );
                addMessage(`Sent: ${content}`);
            } else {
                addMessage('Please connect first and fill all fields');
            }
        }

        function addMessage(txt) {
            const ul = document.getElementById('messages');
            const li = document.createElement('li');
            li.textContent = txt;
            ul.appendChild(li);
        }
    </script>
</body>
</html>